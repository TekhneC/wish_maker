````md
# AGENTS.md — New Year Check-in Wish Page

## 1. 项目概览
这是一个运行在服务器上的单页签到网页，用于新年活动现场由签到者在**我的电脑**依次访问并提交“新年寄语”。页面底部提供白色圆角输入栏与黄色纸飞机发送键；发送后寄语以“从夜空中浮现并上浮”的方式加入夜空展示。  
页面刷新时需同时展示两类数据：**最近若干条历史寄语**与**从数据库随机抽取的其他寄语**，以保证历史寄语在多次刷新后都能逐渐被看到。

本服务不会部署到公网或内网，只在服务器上监听回环地址，并通过端口映射到本地访问。

---

## 2. 运行环境
### 2.1 系统与版本
- OS：Ubuntu 18.04
- Python：使用 conda 管理（建议 Python 3.10/3.11）
- Flask：**3.0.3**
- 数据库：SQLite（本地文件）
- 前端：原生 HTML/CSS/JS（不使用外链 CDN）

### 2.2 环境初始化
在服务器上执行：

```bash
# 1) 创建 conda 环境（示例名）
conda create -n wish-maker python=3.10 -y
conda activate wish-maker

# 2) 安装依赖
python -m pip install -U pip
pip install -r requirements.txt
````

### 2.3 启动与调试

#### 开发调试（带热重载）

```bash
conda activate newyear-checkin
flask --app app run --host 127.0.0.1 --port 8000 --debug
```

#### 稳定运行（可选）

```bash
conda activate newyear-checkin
gunicorn -w 2 -b 127.0.0.1:8000 app:app
```

### 2.4 本地访问（端口映射）

服务端只监听 `127.0.0.1:8000`，在我的电脑上通过 SSH 本地转发访问，例如：

```bash
ssh -L 8080:127.0.0.1:8000 <server>
```

然后在浏览器打开：

* `http://127.0.0.1:8080`

---

## 3. 目录结构与约定

推荐结构：

```
.
├─ app.py
├─ requirements.txt
├─ templates/
│  └─ index.html
├─ static/
│  ├─ css
│  └─ js
├─ data/
│  └─ wishes.sqlite3        # 运行时生成（应加入 .gitignore）
├─ tests/
│  └─ test_api.py
└─ AGENTS.md
```

约定：

* 不引入前端构建工具链（无 Node、无打包）。
* 静态资源只放在 `static/`，模板只放在 `templates/`。
* 数据库文件固定在 `data/` 目录，并确保目录存在（若不存在则自动创建）。
* 页面渲染使用单页，不做多路由、多页面跳转。
* 所有用户输入在前端展示时必须使用 `textContent`，禁止 `innerHTML`。

---

## 4. UI 与动效设计规范

### 4.1 总体风格

* 参考图的“手绘梦幻夜空”质感：深蓝到青蓝的纵向渐变，黄色为点缀色。
* 背景主体装饰：烟花光点与火花组成的镂空文字 **“TOWARDS 2026”**。它不是水印，应清晰可辨但克制，不压寄语内容。
* 底部交互区：白色圆角输入栏（pill），右侧黄色纸飞机按钮，视觉上要明确“可点击”。

### 4.2 常驻微动效（氛围）

* 星点闪烁：低幅度 opacity 波动，随机相位/延迟，避免规律感。
* 流星：间歇出现而非常驻。建议随机间隔（例如 6–20s）在上半屏短暂划过（0.8–1.5s），带淡拖尾后消失。
* “TOWARDS 2026”烟花字：允许非常轻微的火花呼吸/闪动，但必须克制，避免抢夺注意力。

### 4.3 发送交互动效（核心链路）

发送应形成连贯节奏：

1. 按钮反馈：纸飞机按钮短促按压（scale/亮度 80–150ms）。
2. 飞行动画：纸飞机沿小弧线向右上飞出（300–600ms），带少量火花尾迹。
3. 寄语浮现：寄语从靠近底部区域起始，透明→清晰、略放大并缓慢上浮，随后进入轻微漂浮/呼吸状态并留在夜空。

### 4.4 寄语布局规则

* 出现区域必须避开输入栏与屏幕边缘，建议限制在中间安全带。
* 尽量避免重叠：若新寄语与已有寄语发生遮挡，采用简单避让（上移/横移微调、或尝试若干次随机位置）。
* 页面保留寄语数量上限建议为 50（超过可移除最旧或逐步淡出），避免 DOM 过大影响动效稳定性。

---

## 5. 数据库规范

### 5.1 SQLite 位置

* 文件路径：`data/wishes.sqlite3`
* 需保证 `data/` 目录存在（启动时创建）。

### 5.2 表结构

表 `wishes`：

| 字段         | 类型      | 约束                        | 说明             |
| ---------- | ------- | ------------------------- | -------------- |
| id         | INTEGER | PRIMARY KEY AUTOINCREMENT | 自增主键           |
| text       | TEXT    | NOT NULL                  | 寄语正文（trim 后入库） |
| created_at | TEXT    | NOT NULL                  | ISO8601 时间戳    |

建议索引：

* `CREATE INDEX IF NOT EXISTS idx_wishes_created_at ON wishes(created_at);`

### 5.3 查询策略（刷新覆盖要求）

页面初始化返回两组数据：

* recent：最近 N 条（按 created_at 降序）
* random：随机 M 条（尽量排除 recent 的 id 集合，避免重复）

目标：随着多次刷新，历史寄语应以随机抽样方式逐步出现，避免页面永远只展示最新内容。

实现建议：

* 小数据量：`ORDER BY RANDOM() LIMIT M` 可接受。
* 若未来数据量明显增大，可改为“随机 id 抽样”以避免全表随机排序。

---

## 6. 开发与重构原则

* 先稳定交互体验：优先保证“输入—发送—浮现上浮—刷新加载”的端到端闭环。
* 控制依赖：后端保持 Flask + SQLite；前端保持原生；不引入外链与重型库。
* 清晰分层：后端只做数据与接口，前端负责呈现与动效；避免在模板中堆叠复杂逻辑。
* 可维护性优先：动效实现要可读、可调参（例如把随机间隔、上浮速度、上限条数等集中成配置）。
* 安全底线：输入校验（空/超长）、输出转义（前端 textContent）、日志中不打印敏感信息（本项目基本无敏感信息）。
* 重构只在有收益时做：任何抽象（组件化/工程化）都必须明显降低复杂度或提升稳定性。

---

## 7. 测试与自检

### 7.1 自动化测试（pytest）

至少覆盖：

* `POST /api/wishes`：空字符串/全空格拒绝；超长拒绝；正常提交成功并落库。
* `GET /api/wishes/seed`（或等价聚合接口）：返回 recent 条数正确；random 条数正确；random 与 recent 尽量无重复（可允许极端情况下不足量但需说明）。
* 数据库初始化：首次启动能创建表与索引。

### 7.2 手工自检清单

* 视觉：夜空渐变、烟花镂空 “TOWARDS 2026”、底部输入栏与纸飞机按钮风格符合参考图气质。
* 交互：回车可发送；发送后输入清空且光标回到输入框；连续多位签到操作流畅。
* 动效：纸飞机起飞自然；寄语浮现上浮不突兀；星光闪烁与流星间歇出现稳定不过度。
* 刷新：每次刷新同时看到“最近 + 随机”；多刷几次能看到不同历史寄语逐渐出现。
* 稳定：运行 10 分钟以上无明显卡顿、内存持续上涨或动效抖动。


## 8. 对 AI 代理的说明（增强版）

### 8.1 严禁事项

* 严禁引入新的后端框架（例如 Django/FastAPI 等），项目保持 Flask + SQLite 的最小栈不变。
* 严禁修改系统配置或执行需要 root 权限的命令（例如 apt-get、systemctl）。如确有必要，只能给出建议与手工步骤，不得自动执行。
* 严禁自动执行 `git commit` / `git push`。
* 严禁在模板中内联大量 CSS/JS；样式与脚本应放入 `static/` 并保持命名清晰。
* 严禁通过删除表、删除字段的方式修改数据库结构；避免破坏已有数据。
* 严禁引入 Docker、Node 打包链或外链 CDN；所有资源必须本地可用、可离线运行（本项目部署与访问方式决定了这一点）。
* 严禁把服务监听地址改为对外可访问网卡（必须保持 `127.0.0.1` 监听），不得制造公网/内网暴露风险。

### 8.2 依赖管理与环境约束

* 任何运行命令前，必须先完成依赖安装并用 import 验证/
* 任何新增 Python 依赖，必须同步更新 `requirements.txt`，且不要在代码里假设依赖“默认已安装”。
* 环境以 conda 为准，优先使用纯 Python 依赖；不新增系统层依赖（需要 apt 的一律不做自动化安装）。
* 不要在代码中假设服务器存在 GUI；所有调试输出应基于日志/终端可读信息（避免依赖本地桌面环境）。

### 8.3 变更说明要求

每次提交修改（PR 或等价变更说明）必须清晰列出：本次修改涉及的文件列表、每个文件的主要改动点，以及本地/服务器验证步骤（包含访问的 URL 与预期行为）。

### 8.4 数据库相关约束

* 尽量避免修改表结构；若确需修改，必须先在说明中给出迁移方案（备份方式、迁移步骤、回滚策略），并在获得许可后再改。
* 所有数据库操作使用参数化 SQL（或等价安全方式），避免 SQL 注入与字符串拼接。
* 任何会影响“刷新展示覆盖率（最近+随机）”的查询改动，都必须解释其对覆盖率与重复率的影响，并提供可复现的验证方法。

### 8.5 UI/动效实现约束（本项目特有）

* 动效优先采用轻量实现（CSS 动画与少量 requestAnimationFrame），避免复杂物理模拟与重型粒子系统，确保长时间运行不卡顿。
* 所有关键参数需集中成配置（例如 recent N、random M、寄语最大展示数、流星出现间隔范围、漂浮速度等），便于现场快速调参。
* 用户输入展示必须使用 `textContent` 等安全方式，禁止 `innerHTML`；发送前后端都要做 trim、空值与长度校验。

### 8.6 文档同步

如对入口文件、监听端口、数据库路径、接口形态、目录结构等做出实质调整，必须同步更新 AGENTS.md 相关段落以保持一致。
